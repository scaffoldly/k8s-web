# K8s-Web Project Documentation

## Project Overview

This is a TypeScript monorepo that generates Kubernetes API client libraries for Angular and React from OpenAPI v3 specifications. The project uses:

- **Yarn workspaces** for monorepo management
- **Orval** for generating TypeScript clients from OpenAPI specs
- **tsup** for building TypeScript packages
- **ESLint** and **Prettier** for code quality

## Architecture

```
k8s-web/
├── openapi-specs/           # Fetched OpenAPI v3 specs from kube-apiserver
│   ├── *.json              # Individual API group specs (46 files)
│   └── _merged.json        # Merged single spec (generated)
├── common/                  # Dev-only utilities (not built/published)
│   └── src/
│       └── generate-utils.ts    # Shared client generation logic
├── angular/                 # Angular client library workspace
│   ├── src/
│   │   ├── generated/      # Auto-generated from merged OpenAPI spec (tags-split mode)
│   │   │   ├── core-v1/    # Core v1 API group
│   │   │   │   └── core-v1.service.ts (~4,295 lines)
│   │   │   ├── apps-v1/    # Apps v1 API group
│   │   │   │   └── apps-v1.service.ts (~1,483 lines)
│   │   │   ├── ... (46 tag folders total)
│   │   │   └── models/     # Shared TypeScript models
│   │   │       ├── index.ts
│   │   │       └── ... (1,355 model files)
│   │   ├── config.ts       # Configuration interface and InjectionToken
│   │   ├── interceptor.ts  # HTTP interceptor for baseURL and auth
│   │   └── index.ts        # Barrel exports from all tags + models + config
│   ├── scripts/
│   │   └── generate.ts     # Angular generation entry point
│   └── dist/               # Built artifacts (generated by tsup)
├── react/                   # React client library workspace
│   ├── src/
│   │   ├── generated/      # Auto-generated from merged OpenAPI spec (tags-split mode)
│   │   │   ├── core-v1/    # Core v1 API group
│   │   │   │   └── core-v1.ts (TanStack Query hooks)
│   │   │   ├── apps-v1/    # Apps v1 API group
│   │   │   │   └── apps-v1.ts (TanStack Query hooks)
│   │   │   ├── ... (46 tag folders total)
│   │   │   └── models/     # Shared TypeScript models
│   │   │       ├── index.ts
│   │   │       └── ... (1,355 model files)
│   │   ├── config.ts       # Configuration interface and functions
│   │   ├── fetch-instance.ts   # Fetch-based HTTP client mutator
│   │   └── index.ts        # Barrel exports from all tags + models + config
│   ├── scripts/
│   │   └── generate.ts     # React generation entry point
│   └── dist/               # Built artifacts (generated by tsup)
└── scripts/
    └── fetch-specs.ts      # Fetches OpenAPI specs from kube-apiserver
```

## Key Technical Decisions

### 1. No Axios Dependencies

- **Angular**: Uses native `HttpClient` with dependency injection
- **React**: Uses native `fetch` API with TanStack Query hooks
- **Reason**: Framework-appropriate HTTP clients, no external axios dependency

### 2. Tags-Split Generation Mode

- All 46 Kubernetes API group specs are merged into a single OpenAPI document
- Orval uses `tags-split` mode to organize generated code by OpenAPI tags (API groups)
- Generates 46 tag-specific folders + 1 shared models folder (1,258 total files)
- **Benefits**:
  - Organized by API group (core-v1, apps-v1, etc.)
  - Smaller individual files (largest is ~4,295 lines vs 3.4 MB single file)
  - Better IDE performance (only loads what you import)
  - Deduplication of shared types in models/ folder
  - Barrel exports from index.ts allow simple imports
  - Tag-specific imports enable better tree-shaking
- **Tradeoffs**:
  - More files to manage (1,258 vs 1)
  - Need to know which tag contains which resource for specific imports

### 3. Custom Merge Implementation

- Uses simple `Object.assign()` to merge specs in `mergeOpenAPISpecs()`
- Later specs overwrite earlier ones for duplicate paths (last wins)
- Merges paths, schemas, and other component types
- Tried `openapi-merge-cli` but it failed on duplicate path conflicts in K8s specs
- Creates `_merged.json` in openapi-specs directory (excluded from version control via `_` prefix)

## How It Works

### Fetching Specs

```bash
yarn fetch-specs
```

**Prerequisites:**

- Docker must be running
- kube-apiserver container must be started (via Makefile or docker compose)

**Process:**

1. Sets `NODE_TLS_REJECT_UNAUTHORIZED='0'` to bypass self-signed cert verification
2. Fetches OpenAPI v3 discovery document from `https://localhost:6443/openapi/v3`
3. Downloads each API group spec using native `fetch` API
4. Saves to `openapi-specs/*.json`
5. Uses bearer token authentication: `Bearer secret-token`

**Note:** The kube-apiserver is typically started via:

```bash
make 1.31  # Starts k8s v1.31 and generates clients
# OR manually:
K8S_VERSION=1.31 docker compose up -d
```

### Generating Clients

```bash
# Generate both Angular and React clients
yarn generate

# Or individually
yarn workspace @k8s-web/angular generate
yarn workspace @k8s-web/react generate
```

**Generation Process** (in `common/src/generate-utils.ts`):

1. **Merge specs**: Combines all `openapi-specs/*.json` files into `_merged.json`
   - Merges paths, schemas, and other components
   - Handles duplicates by overwriting (last wins)

2. **Generate client**: Calls Orval with merged spec
   - **Angular**: Generates Angular services with HttpClient
   - **React**: Generates TanStack Query hooks with fetch

3. **Create index**: Generates `src/index.ts` that re-exports everything

4. **Format**: Runs Prettier on all generated files

5. **Lint**: Runs ESLint on `src/generated/**/*.ts`
   - **CRITICAL**: Build fails if ESLint errors are found
   - Ensures generated code meets quality standards

## Key Files

### `common/src/generate-utils.ts`

The heart of the generation system. Contains:

- `mergeOpenAPISpecs()`: Merges all API group specs into one
- `generateClients()`: Main generation orchestration
  - Merges specs
  - Calls Orval
  - Formats and lints code
  - Fails build on lint errors

### `react/src/fetch-instance.ts`

HTTP client for React (fetch-based):

```typescript
export const customInstance = <T>(config: {
  url: string;
  method: string;
  params?: any;
  data?: any;
  headers?: any;
  signal?: AbortSignal;
}): Promise<T>
```

Used as Orval mutator for React client generation. Lives in React workspace to avoid runtime dependency on common.

### `scripts/fetch-specs.ts`

Fetches OpenAPI specs from kube-apiserver:

- Uses native `fetch` API (converted from axios)
- Handles self-signed certs
- Saves individual API group specs

### `angular/scripts/generate.ts`

Angular-specific generation config:

```typescript
generateClients({
  projectName: 'Angular',
  specsDir: path.join(__dirname, '../../openapi-specs'),
  srcGeneratedDir: path.join(__dirname, '../src/generated'),
  projectRoot: path.join(__dirname, '..'),
  rootDir: path.join(__dirname, '../..'),
  client: 'angular', // Uses Angular HttpClient, no mutator
});
```

### `react/scripts/generate.ts`

React-specific generation config:

```typescript
generateClients({
  projectName: 'React',
  specsDir: path.join(__dirname, '../../openapi-specs'),
  srcGeneratedDir: path.join(__dirname, '../src/generated'),
  mutatorPath: path.join(__dirname, '../src/fetch-instance.ts'),
  projectRoot: path.join(__dirname, '..'),
  rootDir: path.join(__dirname, '../..'),
  client: 'react-query', // Uses fetch with TanStack Query
});
```

## Configuration

Both Angular and React clients require configuration of the Kubernetes API server URL and authentication before use.

### React Configuration

Configure the client before making any API calls:

```typescript
import { configureK8sClient } from '@k8s-web/react';

// Configure with bearer token
configureK8sClient({
  baseURL: 'https://my-cluster.example.com',
  token: 'my-service-account-token',
});

// Or configure with custom headers
configureK8sClient({
  baseURL: 'https://my-cluster.example.com',
  headers: {
    Authorization: 'Bearer my-token',
    'X-Custom-Header': 'value',
  },
});
```

**Environment variables** (optional):

- `K8S_API_URL`: Sets the default baseURL
- `K8S_API_TOKEN`: Sets the default authentication token

If `K8S_API_URL` is set, the client will be automatically configured. Otherwise, you must call `configureK8sClient()` before making any API calls.

### Angular Configuration

Configure the client in your app configuration:

```typescript
import { ApplicationConfig } from '@angular/core';
import { provideHttpClient, withInterceptors } from '@angular/common/http';
import { k8sClientInterceptor, K8S_CLIENT_CONFIG } from '@k8s-web/angular';

export const appConfig: ApplicationConfig = {
  providers: [
    // Provide the HTTP client with the k8s interceptor
    provideHttpClient(withInterceptors([k8sClientInterceptor])),

    // Configure the K8s client
    {
      provide: K8S_CLIENT_CONFIG,
      useValue: {
        baseURL: 'https://my-cluster.example.com',
        token: 'my-service-account-token',
      },
    },
  ],
};
```

**Alternative: Using custom headers**

```typescript
{
  provide: K8S_CLIENT_CONFIG,
  useValue: {
    baseURL: 'https://my-cluster.example.com',
    headers: {
      'Authorization': 'Bearer my-token',
      'X-Custom-Header': 'value',
    }
  }
}
```

**Note**: The `k8sClientInterceptor` only intercepts relative URLs (K8s API calls), so other HTTP requests in your app are not affected.

## Usage

### Angular

**Simple imports (barrel exports from index.ts):**

```typescript
import { CoreV1Service, AppsV1Service } from '@k8s-web/angular';
import type { IoK8sApiCoreV1Pod } from '@k8s-web/angular';

// Inject services in your component
constructor(private coreV1: CoreV1Service) {}

// Use the service methods
this.coreV1.listNamespacedPod({ namespace: 'default' }).subscribe(pods => {
  console.log(pods);
});
```

**Tag-specific imports (better tree-shaking):**

```typescript
import { CoreV1Service } from '@k8s-web/angular/core-v1';
import { AppsV1Service } from '@k8s-web/angular/apps-v1';
import type { IoK8sApiCoreV1Pod } from '@k8s-web/angular/models';
```

### React

**Simple imports (barrel exports from index.ts):**

```typescript
import { useListCoreV1NamespacedPod, useListAppsV1NamespacedDeployment } from '@k8s-web/react';
import type { IoK8sApiCoreV1Pod } from '@k8s-web/react';

// Use TanStack Query hooks
function MyComponent() {
  const { data, isLoading, error } = useListCoreV1NamespacedPod({
    namespace: 'default',
  });

  return <div>{/* render pods */}</div>;
}
```

**Tag-specific imports (better tree-shaking):**

```typescript
import { useListCoreV1NamespacedPod } from '@k8s-web/react/core-v1';
import { useListAppsV1NamespacedDeployment } from '@k8s-web/react/apps-v1';
import type { IoK8sApiCoreV1Pod } from '@k8s-web/react/models';
```

## Dependencies

### Root Dependencies

- `orval`: OpenAPI to TypeScript generator
- `prettier`: Code formatting
- `eslint`: Linting
- `typescript`: TypeScript compiler
- `tsx`: TypeScript execution
- `glob`: File pattern matching
- `@types/eslint`: TypeScript types for ESLint

### Angular Workspace

- `@angular/core`, `@angular/common`: Angular framework
- `rxjs`, `zone.js`: Angular dependencies
- `tsup`: TypeScript bundler

### React Workspace

- `react`: React framework
- `@tanstack/react-query`: Data fetching library
- `tsup`: TypeScript bundler

### Common Workspace (Dev-Only)

- **No runtime dependencies**
- **Not built or published** - only contains dev utilities
- `typescript`, `@types/node`: For TypeScript support in generation scripts

## Build Process

```bash
# Build published workspaces (common is not built)
yarn build
# Or individually:
yarn workspace @k8s-web/angular build
yarn workspace @k8s-web/react build
```

Each workspace uses `tsup` to:

- Bundle TypeScript source
- Generate CommonJS output (`dist/index.js`)
- Generate type declarations (`dist/index.d.ts`)
- Generate source maps (`dist/index.js.map`)

## Clean Targets

### `make clean`

Removes all generated code and build artifacts:

- `angular/src/generated/` - Generated Angular client
- `react/src/generated/` - Generated React client
- `angular/src/index.ts` - Generated index file
- `react/src/index.ts` - Generated index file
- `angular/dist/` - Angular built artifacts
- `react/dist/` - React built artifacts
- `openapi-specs/_merged.json` - Merged OpenAPI spec
- `openapi-specs/_merge-config.json` - Merge configuration (if exists)

**Note**: `common/` is NOT built (it's dev-only utilities)
**KEEPS** the fetched OpenAPI specs (`openapi-specs/*.json`)

### `make clean-all`

Removes everything including fetched specs:

- Everything from `make clean`
- Entire `openapi-specs/` directory
- Stops and removes Docker containers (kube-apiserver, etcd)

## Important Notes

### Generation Files

Files starting with `_` in `openapi-specs/` are ignored during spec file enumeration:

- `_merged.json`: The merged OpenAPI spec (generated during client generation)
- `_merge-config.json`: Temporary merge config (no longer used, can be ignored)

### Generated Code Details

**Angular (`angular/src/generated/`):**

- **Structure**: 46 tag folders + 1 models folder (1,258 total files)
- **Tag files**: `{tag}.service.ts` (e.g., `core-v1.service.ts` with ~4,295 lines)
- **Contains**: `@Injectable` services using Angular's HttpClient
- **Example service**: `CoreV1Service` with methods like `listNamespacedPod()`
- **Models**: 1,355 shared TypeScript model files in `models/` folder
- **Uses**: Dependency injection pattern
- **Index**: Barrel exports from `src/index.ts` for all tags + models

**React (`react/src/generated/`):**

- **Structure**: 46 tag folders + 1 models folder (1,258 total files)
- **Tag files**: `{tag}.ts` (e.g., `core-v1.ts` with TanStack Query hooks)
- **Contains**: TanStack Query hooks for all K8s API operations
- **Example hooks**: `useListCoreV1NamespacedPod()`, `useListAppsV1NamespacedDeployment()`
- **Models**: 1,355 shared TypeScript model files in `models/` folder
- **Imports**: `customInstance` from `../fetch-instance` (within React workspace)
- **Index**: Barrel exports from `src/index.ts` for all tags + models

### Build Outputs

- **Angular dist**: ~7.3 MB (index.js ~283 KB, index.d.ts ~3.4 MB, source maps ~3.6 MB)
- **React dist**: ~11 MB (index.js ~1.1 MB, index.d.ts ~4.5 MB, source maps ~5.4 MB)
- Both use CommonJS format (`tsup --format cjs`)

### TypeScript Configuration

- **React**: `tsconfig.json` includes `../common/src/**/*` to resolve cross-workspace imports
- Both workspaces remove `rootDir` constraint to allow importing from common

### ESLint Integration

- Generation **fails** if ESLint finds errors in generated code
- Only lints `src/generated/**/*.ts` files
- Automatically applies fixes where possible
- Exit code 1 if errors remain after fixes

### Prettier Integration

- Index file is formatted immediately when created
- All generated files are formatted after generation
- Uses project's `.prettierrc` config

## Troubleshooting

### Issue: "File is not under rootDir"

**Solution**: Removed `rootDir` from React's tsconfig.json and added `../common/src/**/*` to `include`

### Issue: "Could not find module 'rxjs'"

**Solution**: Added `rxjs` and `zone.js` as devDependencies in Angular workspace

### Issue: "signal does not exist in type"

**Solution**: Added `signal?: AbortSignal` to fetch-instance config type

## Current State

- ✅ **Axios completely removed** from codebase
- ✅ **All specs merged** into single OpenAPI document (374 paths, 532 schemas from 46 API groups)
- ✅ **Tags-split mode** - organized into 46 tag folders + 1 models folder (1,258 total files per workspace)
- ✅ **Angular** uses HttpClient with dependency injection (@Injectable services in tag-specific files)
- ✅ **React** uses fetch API with TanStack Query hooks (tag-specific hook files)
- ✅ **ESLint enforced** at generation time (fails build on errors)
- ✅ **Prettier formats** all generated code with proper singleQuote configuration
- ✅ **Barrel exports** from index.ts for simple imports + tag-specific imports for tree-shaking
- ✅ **Common is dev-only** - private package, no runtime dependencies, not built or published
- ✅ **React is standalone** - includes its own fetch-instance.ts (no dependency on common)
- ✅ **Both workspaces build successfully** as standalone packages
- ✅ **SSL bypass configured** for kube-apiserver self-signed certs (`NODE_TLS_REJECT_UNAUTHORIZED='0'`)
- ✅ **Native fetch** used everywhere (scripts and React runtime)
- ✅ **Tested with Kubernetes v1.31**
- ✅ **Environment configuration** - baseURL and auth configurable via code or env vars
  - React: `configureK8sClient()` function, supports `K8S_API_URL` and `K8S_API_TOKEN` env vars
  - Angular: `K8S_CLIENT_CONFIG` InjectionToken with `k8sClientInterceptor`
  - Both require explicit baseURL configuration (no hardcoded defaults)

## Known Issues & Limitations

1. **Many generated files**: 1,258 files per workspace (46 tag folders + 1,355 model files). Git operations may be slower with this many files.
2. **SSL verification disabled**: `NODE_TLS_REJECT_UNAUTHORIZED='0'` is used for development when fetching specs from kube-apiserver. This is only for the fetch-specs script, not the client libraries.
3. **Duplicate path handling**: When specs have duplicate paths, last spec wins (simple overwrite, no conflict resolution).
4. **Tag naming**: Orval converts tag names to kebab-case folder names (e.g., `core_v1` → `core-v1`), which affects import paths.

## Next Steps

1. **Add React hooks helpers**: Create convenience hooks for common operations (e.g., `useNamespacedPods()`)
2. **Add Angular interceptors**: Create additional interceptors for error handling and retry logic (auth interceptor already exists)
3. **Publishing**: Configure for npm publishing
   - Add proper `package.json` metadata (description, repository, etc.)
   - Consider separate versioning for Angular and React packages
   - Configure npm publishing workflow
4. **Documentation**: Generate API docs from OpenAPI specs using tools like TypeDoc
5. **Testing**: Add integration tests for generated clients
6. **Optimization**: Consider adding `.gitignore` patterns for generated files if repository size becomes an issue

## Quick Reference

### Common Commands

```bash
# Full workflow for a Kubernetes version
make 1.31                    # Fetches specs, generates clients, builds packages

# Individual steps
yarn fetch-specs             # Only fetch OpenAPI specs
yarn generate                # Only generate clients (requires specs)
yarn build                   # Only build packages (requires generated code)

# Cleanup
make clean                   # Remove generated code and builds (keep specs)
make clean-all              # Remove everything including specs and Docker containers

# Development
yarn workspace @k8s-web/angular dev    # Watch mode for Angular
yarn workspace @k8s-web/react dev      # Watch mode for React
```

### Docker Management

```bash
# Start kube-apiserver manually
K8S_VERSION=1.31 docker compose up -d

# Stop containers
docker compose down

# View logs
docker logs k8s-apiserver
docker logs k8s-etcd
```

### File Locations

- **Generated clients**: `{angular,react}/src/generated/kubernetes.ts`
- **Index exports**: `{angular,react}/src/index.ts`
- **Built packages**: `{angular,react}/dist/`
- **OpenAPI specs**: `openapi-specs/*.json`
- **Merged spec**: `openapi-specs/_merged.json`
- **React HTTP client**: `react/src/fetch-instance.ts`
- **Generation utilities**: `common/src/generate-utils.ts`
